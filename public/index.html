<!DOCTYPE html>
<html>
<head>
    <title>Shitty Green screen</title>

    <style type="text/css">
        img, video {
            display: none;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #controls {
            position: absolute;
            bottom: 0;
            /*left: 0;*/
            right: 0;
        }
    </style>
</head>

<body style="height: 100%;width: 100%;">
<img src="/randomImage.jpg" id="original_image"/>
<img src="images/backgrounds/pizza-background.jpg" id="background_image"/>

<h1>PRESS 'f' for fullscreen</h1>

<canvas id="canvas" width="800" height="800"></canvas>

<div id="controls">
    <div>
        <label for="weight">Weight</label>
        <input type="range" id="weight" min="0" max="5" step="0.01" value="1.32"/>
    </div>
    <div>
        <label for="balance">Balance</label>
        <input type="range" id="balance" min="0" max="2" step="0.01" value="0.5"/>
    </div>
    <div>
        <label for="clipWhite">clipWhite</label>
        <input type="range" id="clipWhite" min="0" max="1" step="0.001" value="0.85"/></div>
    <div>
        <label for="clipBlack">clipBlack</label>
        <input type="range" id="clipBlack" min="0" max="1" step="0.0005" value="0.5125"/>
    </div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<!-- page content goes here -->
<script src="./lib/seriouslyjs/lib/require.js"></script>
<script>
    require.config({
        baseUrl: 'lib/seriouslyjs/'
    });

    require([
        'seriously',
        'effects/seriously.chroma',
        'effects/seriously.bleach-bypass',
        'effects/seriously.blend'

    ], function (Seriously) {
        //main code goes here

        var foregroundImage = 1;
        var backgroundImage = 1;

        var foregroundTimer = 2000;
        var backgroundTimerMultuiplier= 3;

        var seriously = new Seriously(), // the main object that holds the entire composition
                original_image, // a wrapper object for our source image
                background_image,
                chroma = seriously.effect('chroma'),
                bleach = seriously.effect('bleach-bypass'),
                blend = seriously.effect('blend'),
                target,// a wrapper object for our target canvas
                x = 0,
                y = 0,
                vx = 0,
                vy = 0,
                lastFrameTime = Date.now();


        function resize() {
            var aspect = window.innerWidth / window.innerHeight;
            target.width = Math.min(960, window.innerWidth);
            target.height = target.width / aspect;
            reformatForOutput.width = target.width;
            reformatForOutput.height = target.height;
        }

        function chromaMagic() {
            // declare our variables


// Create a source object by passing a CSS query string.
            original_image = seriously.source('#original_image');

            scaleImage = seriously.transform('2d');
            scaleImage.source = original_image;
            scaleImage.scale(800 / 800);
            original_image = scaleImage;


            reformat = seriously.transform('reformat');
            reformatForOutput = seriously.transform('reformat');
            reformat.width = 1280;
            reformat.height = 720;
            reformat.mode = 'none';
            reformatForOutput.mode = 'cover';


            background_image = seriously.source('#background_image');
// now do the same for the target canvas
            target = seriously.target('#canvas');


// Apply all sorts of freakin' awesome effects !!!

            //little bit of bleaching to remove oversaturated reds etc...
            bleach.source = scaleImage;
            bleach.amount = 0.5;

            chroma.weight = '#weight'; //how much of the screen color to remove from semi-transparent
            chroma.balance = '#balance'; //it's complicated. Play with it.
            chroma.screen = 'rgb(77, 239, 41)';
            chroma.clipWhite = '#clipWhite'; //The maximum resulting alpha value of keyed pixels
            chroma.clipBlack = '#clipBlack';  //The minimum resulting alpha value of keyed pixels


            chroma.source = bleach;

            var moveMask = seriously.transform();
            moveMask.source = chroma;
            moveMask.translateX = 0;
            moveMask.scale(0.5);


            blend.mode = 'normal';
            blend.bottom = background_image;
            blend.top = moveMask;

// connect any node as the source of the target. we only have one.

            reformatForOutput.source = blend;
            target.source = reformatForOutput;

            seriously.go(function (now) {


            });
        }


        function init() {
            chromaMagic();
            resize();
            window.onresize = resize;
            // Start looping
            StartForegroundLoop();
            StartBackgroundLoop();
        }


        function changeForeground() {
            $('#original_image').attr('src', '/randomImage.jpg?'+foregroundImage);
            foregroundImage++;
        }

        function changeBackground() {
            $('#background_image').attr('src', '/randomBackground.jpg?'+backgroundImage);
            backgroundImage++;
        }

        function StartForegroundLoop() {
            setInterval(changeForeground, foregroundTimer); // repeat myself
        }

        function StartBackgroundLoop(){
            setInterval(changeBackground, foregroundTimer * backgroundTimerMultuiplier); // repeat myself
        }


        //seriously.go(function (now) {

//            var diff = (now - lastFrameTime) / 1000;
//
//            vx = Math.min(Math.max(vx + (Math.random() - 0.5) * 100, -200), 200);
//            vy = Math.min(Math.max(vy + (Math.random() - 0.5) * 100, -200), 200);
//            if (x > 435 || x < -435) {
//                vx *= 1;
//            }
//            if (y > 148 || y < -148) {
//                vy *= 1;
//            }
//            x = Math.min(Math.max(x + vx * diff, -250), 250);
//            y = Math.min(Math.max(y + vy * diff, -148), 148);
//            moveMask.translateX = x;
//            moveMask.translateY = y;
//            lastFrameTime = now;

        //});

        init();

    });


    document.cancelFullScreen = document.webkitExitFullscreen || document.mozCancelFullScreen || document.exitFullscreen;

    var elem = document.querySelector("#canvas");

    document.addEventListener('keydown', function (e) {
        switch (e.keyCode) {
            case 13: // ENTER. ESC should also take you out of fullscreen by default.
                e.preventDefault();
                document.cancelFullScreen(); // explicitly go out of fs.
                break;
            case 70: // f
                enterFullscreen();
                break;
        }
    }, false);

    function onFullScreenEnter() {
        console.log("Entered fullscreen!");
        elem.onwebkitfullscreenchange = onFullScreenExit;
        elem.onmozfullscreenchange = onFullScreenExit;
    }
    ;
    // Note: FF nightly needs about:config full-screen-api.enabled set to true.
    function enterFullscreen() {
        console.log("enterFullscreen()");
        elem.onwebkitfullscreenchange = onFullScreenEnter;
        elem.onmozfullscreenchange = onFullScreenEnter;
        elem.onfullscreenchange = onFullScreenEnter;
        if (elem.webkitRequestFullscreen) {
            elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
        } else {
            if (elem.mozRequestFullScreen) {
                elem.mozRequestFullScreen();
            } else {
                elem.requestFullscreen();
            }
        }
        document.getElementById('enter-exit-fs').onclick = exitFullscreen;
    }
    function exitFullscreen() {
        console.log("exitFullscreen()");
        document.cancelFullScreen();
        document.getElementById('enter-exit-fs').onclick = enterFullscreen;
    }


</script>


</body>
</html>