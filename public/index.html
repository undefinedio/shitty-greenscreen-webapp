<!DOCTYPE html>
<html>
<head>
    <title>Shitty Party Gallery</title>
    <meta property="og:title" content="Shitty Party Gallery"/>
    <meta property="og:image" content="https://shitty-partypics.herokuapp.com/images/share.jpg"/>
    <meta property="og:site_name" content="Shitty Party Gallery"/>
    <meta property="og:description"
          content="This was the shitty party. The biggest muilfestijn from Antwerpen and surrounding parking. A big up to the Muiltatuli and the lovely crowd. See you next time!"/>
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

    <style type="text/css">
        img, video {
            display: none;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #controls {
            position: absolute;
            bottom: 0;
            /*left: 0;*/
            right: 0;
            color: white;
            opacity: 0;
        }

        #back, #next {
            color: white;
            font-size: 72px;
            position: absolute;
            top: 50%;
            z-index: 100;
            -webkit-transform: translateY(-50%);
            -moz-transform: translateY(-50%);
            -ms-transform: translateY(-50%);
            -o-transform: translateY(-50%);
            transform: translateY(-50%);
            text-decoration: none;
        }

        #next {
            right: 9px;
        }

        .muile {
            display: block;
            z-index: 100;
            position: absolute;
        }

        #fblikebutton {
            z-index: 100;
            position: absolute !important;
            bottom: 20px;
            left: 20px;
            color: white;
            font-size: 10px;
        }

        .shitty-logo {
            display: block;
            z-index: 100;
            position: absolute;
            bottom: 100px;
            width: 99px;
            left: 30px;
            text-align: center;
            color: #fff;
            text-transform: uppercase;
            font-size: 10px;
        }

        .shitty-logo img {
            width: 99px;
            display: block;
            margin-bottom: 15px;
        }

        .fb-like {
            clear: both;
            display: block !important;
            top: 12px;
        }

        .btn-share {
            z-index: 100;
            position: relative;
            color: white;
            font-size: 30px;
            display: inline-block;
            margin-left: 8px;
            vertical-align: middle;
            cursor: pointer;
        }

        .fb-like {
            clear: both;
            display: block !important;
            top: 12px;
        }
    </style>
</head>

<body style="height: 100%;width: 100%;">
<div id="fb-root"></div>
<script>
    window.fbAsyncInit = function () {
        FB.init({
            appId: '724923360853864',
            xfbml: true,
            version: 'v2.1'
        });
    };
    (function (d, s, id) {
        var js, fjs = d.getElementsByTagName(s)[0];
        if (d.getElementById(id)) {
            return;
        }
        js = d.createElement(s);
        js.id = id;
        js.src = "//connect.facebook.net/en_US/all.js#xfbml=1&appId=724923360853864";
        fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
<div class="shitty-logo">
    <a href="http://shittyguide.org" target="_blank">
        <img src="images/shittyguide.png" alt=""/>
    </a>
    follow us
    <div class="fb-like" data-href="https://www.facebook.com/pages/Shitty-Guide/1426855587594313" data-layout="button_count"
         data-action="like" data-show-faces="false" data-share="false"></div>
</div>
<img src="images/muile.png" class='muile' id="logo" alt=""/>
<img src="/randomImage" id="original_image"/>
<img src="/randomBackground" id="background_image"/>

<!--<h1>PRESS 'f' for fullscreen</h1>-->

<a href="#" id="next">&#9758;</a>
<a href="#" id="back">&#9756;</a>

<div id="fblikebutton">
    SHARE THIS UGLY PIC WITH YOUR FRIEND
    <a class="btn-share" data-share="facebook">
        <i class="fa fa-facebook-square"></i>
    </a>
    <a class="btn-share" data-share="twitter">
        <i class="fa fa-twitter-square"></i>
    </a>
</div>

<canvas id="canvas" width="800" height="800"></canvas>

<div id="controls">
    <div>
        <label for="weight">Weight</label>
        <input type="range" id="weight" min="0" max="20" step="0.01" value="4"/>
    </div>
    <div>
        <label for="balance">Balance</label>
        <input type="range" id="balance" min="0" max="1" step="0.001" value="1"/>
    </div>
    <div>
        <label for="clipWhite">clipWhite</label>
        <input type="range" id="clipWhite" min="0" max="1" step="0.001" value="0"/></div>
    <div>
        <label for="clipBlack">clipBlack</label>
        <input type="range" id="clipBlack" min="0" max="1" step="0.001" value="0.918"/>
    </div>
</div>
<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="./lib/seriouslyjs/lib/require.js"></script>
<script>

$(function ($) {
    $('input').on('change', function () {
        print.call($(this));
    });
    function print() {
        console.log(this.attr('id') + ' -> ' + this.val());
    }
});

require.config({
    baseUrl: 'lib/seriouslyjs/'
});

require([
    'seriously',
    'effects/seriously.chroma',
    'effects/seriously.bleach-bypass',
    'effects/seriously.blend',
    'effects/seriously.ripple'


], function (Seriously) {

    var foregroundImage = 1;
    var backgroundImage = 1;

    var foregroundTimer = 2000;
    var backgroundTimerMultiplier = 3;
    var updown, diff;

    var seriously = new Seriously(), // the main object that holds the entire composition
            original_image, // a wrapper object for our source image
            background_image,
            chroma = seriously.effect('chroma'),
            bleach = seriously.effect('bleach-bypass'),
            blend = seriously.effect('blend'),
            ripple = seriously.effect('ripple'),
            target,// a wrapper object for our target canvas
            x = 0,
            y = 0,
            vx = 0,
            vy = 0,
            lastFrameTime = Date.now();


    function resize() {
        var aspect = window.innerWidth / window.innerHeight;
        target.width = Math.min(960, window.innerWidth);
        target.height = target.width / aspect;
        reformatForOutput.width = target.width;
        reformatForOutput.height = target.height;
    }

    function chromaMagic() {


// Create a source object by passing a CSS query string.
        original_image = seriously.source('#original_image');

        scaleImage = seriously.transform('2d');
        scaleImage.source = original_image;
        scaleImage.scale(1000 / 1000);
        original_image = scaleImage;


        reformat = seriously.transform('reformat');
        reformatForOutput = seriously.transform('reformat');
        reformat.width = 1280;
        reformat.height = 720;
        reformat.mode = 'none';
        reformatForOutput.mode = 'cover';


        background_image = seriously.source('#background_image');
// now do the same for the target canvas
        target = seriously.target('#canvas');


// Apply all sorts of freakin' awesome effects !!!

        //little bit of bleaching to remove oversaturated reds etc...
        bleach.source = scaleImage;
        bleach.amount = 0.5;

        chroma.weight = '#weight'; //how much of the screen color to remove from semi-transparent
        chroma.balance = '#balance'; //it's complicated. Play with it.
        chroma.screen = 'rgb(77, 239, 41)';
        chroma.clipWhite = '#clipWhite'; //The maximum resulting alpha value of keyed pixels
        chroma.clipBlack = '#clipBlack';  //The minimum resulting alpha value of keyed pixels


        chroma.source = bleach;

        var moveMask = seriously.transform();
        moveMask.source = chroma;
        moveMask.translateX = 0;
        moveMask.translateY = -100;
        moveMask.scale(1);

        ripple.source = background_image;

        blend.mode = 'normal';
        blend.bottom = ripple;
        blend.top = moveMask;

// connect any node as the source of the target. we only have one.

        reformatForOutput.source = blend;
        target.source = reformatForOutput;

        seriously.go(function (now) {

            diff = ((now - lastFrameTime) / 1000);

            updown = (Math.sin((diff))) * 50;
            moveMask.translateX = updown;

            ripple.wave = Math.abs(Math.sin(now / 2000 / 4));
            ripple.distortion = Math.abs(Math.sin(now / 1000 / 4.5)) * 2;

        });
    }

    var foregroundImage = 1,
            maxforegroundImages = 127;

    function init() {
        chromaMagic();
        resize();
        window.onresize = resize;
        StartForegroundLoop();
        StartBackgroundLoop();
        startMusic();
        sharePic();
    }

    function sharePic() {

        $('.btn-share').on('click', function () {
            var social = $(this).data("share");
            var winWidth = 370;
            var winHeight = 320;
            var winTop = (screen.height / 2) - (winHeight / 2);
            var winLeft = (screen.width / 2) - (winWidth / 2);

            title = encodeURIComponent("Shitty Party Gallery");
            descr = encodeURIComponent("This was the shitty party. The biggest muilfestijn from Antwerpen and surrounding parking. A big up to the Muiltatuli and the lovely crowd. See you next time!");
            url = encodeURIComponent('https://shitty-partypics.herokuapp.com/#' + foregroundImage);
            image = encodeURIComponent('https://shitty-partypics.herokuapp.com/randomImage?count=' + foregroundImage);

            switch (social) {
                case 'facebook':
                    window.open('http://www.facebook.com/sharer.php?s=100&p[title]=' + title + '&p[summary]=' + descr + '&p[url]=' + url + '&p[images][0]=' + image, 'sharer', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=' + winWidth + ',height=' + winHeight);
                    break;
                case 'twitter':
                    window.open('http://www.twitter.com/share?text=' + descr + ' #shittyguide #antwerpen', 'top=' + winTop + ',left=' + winLeft + ',toolbar=0,scrollbars=0,location=0,statusbar=0,menubar=0,resizable=0,width=' + winWidth + ',height=' + winHeight);
                    break;
            }
        });

    }

    function getRandom(min, max) {
        return min + Math.floor(Math.random() * (max - min + 1));
    }

    function nextPic() {
        if (foregroundImage < maxforegroundImages) {
            foregroundImage++;
        } else {
            foregroundImage = 1;
        }

        window.history.pushState(null, null, '#' + foregroundImage);
        $('#original_image').attr('src', '/randomImage?count=' + foregroundImage);
    }

    function prevPic() {
        if (foregroundImage > 1) {
            foregroundImage--;
        } else {
            foregroundImage = maxforegroundImages;
        }

        window.history.pushState(null, null, '#' + foregroundImage);
        $('#original_image').attr('src', '/randomImage?count=' + foregroundImage);
    }


    function StartForegroundLoop() {
        var type = window.location.hash.substr(1);

        if (type === '') {
            foregroundImage = getRandom(foregroundImage, maxforegroundImages);
        } else {
            foregroundImage = type;
        }

        window.history.pushState(null, null, '#' + foregroundImage);
        $('#original_image').attr('src', '/randomImage?count=' + foregroundImage);

        $('#next').on('click', function (e) {
            e.preventDefault();
            nextPic();
        });


        $('#back').on('click', function (e) {
            e.preventDefault();
            prevPic();
        });

        $(window).keydown(function (e) {
            if (e.keyCode === 39) {
                nextPic();
            }

            if (e.keyCode === 37) {
                prevPic();
            }
        });

    }

    function changeBackground() {
        $('#background_image').attr('src', '/randomBackground?count=' + backgroundImage);
        backgroundImage++;
    }

    function StartBackgroundLoop() {
        setInterval(changeBackground, foregroundTimer * backgroundTimerMultiplier); // repeat myself
    }

    function startMusic() {
        var music = [
                    'hvmKKPU3oJc', // celine dion
                    'VGWlOSMmq5o', // dettweiler
                    'w15oWDh02K4', // gigi
                    'ZnBeTPpr98g', // push
                    'pTtcMP87qz8', // 8 bit
                    'GM5Kw6LVYlk', // nwagezani
                    'g7uHLJOsU_4', // atakak
                    'YK3ZP6frAMc', // popcorn
                    'pgRUHIeaKOk', // omar
                    'D3-vBBQKOYU', // windows error
                ],
                randMusic = music[getRandom(0, music.length - 1)];

        $("body").append('<iframe style="display: none;" width="100%" height="100%" frameborder="0" scrolling="yes" allowtransparency="true" src="//www.youtube.com/embed/' + randMusic + '?autoplay=1&loop=1&playlist=PL759KJQCqtrxBXCyRgWw9w7plLCVsavBY"></iframe>');
    }

    $(function () {
        init();
    });

});


document.cancelFullScreen = document.webkitExitFullscreen || document.mozCancelFullScreen || document.exitFullscreen;

var elem = document.querySelector("#canvas");

document.addEventListener('keydown', function (e) {
    switch (e.keyCode) {
        case 13: // ENTER. ESC should also take you out of fullscreen by default.
            e.preventDefault();
            document.cancelFullScreen(); // explicitly go out of fs.
            break;
        case 70: // f
            enterFullscreen();
            break;
    }
}, false);

// Called whenever the browser exits fullscreen.
function onFullScreenExit() {
    console.log("Exited fullscreen");
}
;

function onFullScreenEnter() {
    console.log("Entered fullscreen!");
    elem.onwebkitfullscreenchange = onFullScreenExit;
    elem.onmozfullscreenchange = onFullScreenExit;
}
;
// Note: FF nightly needs about:config full-screen-api.enabled set to true.
function enterFullscreen() {
    console.log("enterFullscreen()");
    elem.onwebkitfullscreenchange = onFullScreenEnter;
    elem.onmozfullscreenchange = onFullScreenEnter;
    elem.onfullscreenchange = onFullScreenEnter;
    if (elem.webkitRequestFullscreen) {
        elem.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT);
    } else {
        if (elem.mozRequestFullScreen) {
            elem.mozRequestFullScreen();
        } else {
            elem.requestFullscreen();
        }
    }
    document.getElementById('enter-exit-fs').onclick = exitFullscreen;
}

function exitFullscreen() {
    console.log("exitFullscreen()");
    document.cancelFullScreen();
    document.getElementById('enter-exit-fs').onclick = enterFullscreen;
}


</script>

</body>
</html>